<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TasksList</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="header">
        <h1><span class="tasks">Tasks</span>List</h1>
        <button class="add-task-btn" onclick="openAddModal()">‚äï Add Task</button>
    </div>

    <div class="boards-container">
        <!-- Pune Board -->
        <div class="board">
            <div class="board-header">Go To Pune</div>
            {% for task in tasks %}
                {% if task.description == 'Pune' %}
                <div class="task-item {% if task.completed %}completed{% endif %}">
                    <div class="task-content">
                        <input type="checkbox" class="task-checkbox" 
                               onclick="window.location.href='/toggle/{{ task._id }}'"
                               {% if task.completed %}checked{% endif %}>
                        <span class="task-title">{{ task.title }}</span>
                    </div>
                    <div class="task-actions">
                        <button class="icon-btn edit-btn" 
                                data-id="{{ task._id }}" 
                                data-title="{{ task.title|replace('"', '&quot;') }}" 
                                data-description="{{ task.description|replace('"', '&quot;') }}" 
                                data-completed="{{ task.completed }}">‚úèÔ∏è</button>
                        <button class="icon-btn delete-btn" data-id="{{ task._id }}">üóëÔ∏è</button>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
            <div class="board-footer">
                <button class="footer-btn" onclick="openAddModalForCity('Pune')">‚úèÔ∏è</button>
                <button class="footer-btn add-board-btn" onclick="openAddModalForCity('Pune')">+</button>
            </div>
        </div>

        <!-- Mumbai Board -->
        <div class="board">
            <div class="board-header">Go To Mumbai</div>
            {% for task in tasks %}
                {% if task.description == 'Mumbai' %}
                <div class="task-item {% if task.completed %}completed{% endif %}">
                    <div class="task-content">
                        <input type="checkbox" class="task-checkbox" 
                               onclick="window.location.href='/toggle/{{ task._id }}'"
                               {% if task.completed %}checked{% endif %}>
                        <span class="task-title">{{ task.title }}</span>
                    </div>
                    <div class="task-actions">
                        <button class="icon-btn edit-btn" 
                                data-id="{{ task._id }}" 
                                data-title="{{ task.title|replace('"', '&quot;') }}" 
                                data-description="{{ task.description|replace('"', '&quot;') }}" 
                                data-completed="{{ task.completed }}">‚úèÔ∏è</button>
                        <button class="icon-btn delete-btn" data-id="{{ task._id }}">üóëÔ∏è</button>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
            <div class="board-footer">
                <button class="footer-btn" onclick="openAddModalForCity('Mumbai')">‚úèÔ∏è</button>
                <button class="footer-btn add-board-btn" onclick="openAddModalForCity('Mumbai')">+</button>
            </div>
        </div>

        <!-- Other city Board -->
        <div class="board">
            <div class="board-header">Go To Other City</div>
            {% for task in tasks %}
                {% if task.description == 'Add City' %}
                <div class="task-item {% if task.completed %}completed{% endif %}">
                    <div class="task-content">
                        <input type="checkbox" class="task-checkbox" 
                               onclick="window.location.href='/toggle/{{ task._id }}'"
                               {% if task.completed %}checked{% endif %}>
                        <span class="task-title">{{ task.title }}</span>
                    </div>
                    <div class="task-actions">
                        <button class="icon-btn edit-btn" 
                                data-id="{{ task._id }}" 
                                data-title="{{ task.title|replace('"', '&quot;') }}" 
                                data-description="{{ task.description|replace('"', '&quot;') }}" 
                                data-completed="{{ task.completed }}">‚úèÔ∏è</button>
                        <button class="icon-btn delete-btn" data-id="{{ task._id }}">üóëÔ∏è</button>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
            <div class="board-footer">
                <button class="footer-btn" onclick="openAddModalForCity('')">‚úèÔ∏è</button>
                <button class="footer-btn add-board-btn" onclick="openAddModalForCity('')">+</button>
            </div>
        </div>

        <!-- Dynamic Other City Boards -->
        {% set other_cities = [] %}
        {% for task in tasks %}
            {% if task.description and task.description not in ['Pune', 'Mumbai'] %}
                {% if task.description not in other_cities %}
                    {% set _ = other_cities.append(task.description) %}
                {% endif %}
            {% endif %}
        {% endfor %}

        {% for city in other_cities %}
        <div class="board">
            <div class="board-header">Go To {{ city }}</div>
            {% for task in tasks %}
                {% if task.description == city %}
                <div class="task-item {% if task.completed %}completed{% endif %}">
                    <div class="task-content">
                        <input type="checkbox" class="task-checkbox" 
                               onclick="window.location.href='/toggle/{{ task._id }}'"
                               {% if task.completed %}checked{% endif %}>
                        <span class="task-title">{{ task.title }}</span>
                    </div>
                    <div class="task-actions">
                        <button class="icon-btn edit-btn" 
                                data-id="{{ task._id }}" 
                                data-title="{{ task.title|replace('"', '&quot;') }}" 
                                data-description="{{ task.description|replace('"', '&quot;') }}" 
                                data-completed="{{ task.completed }}">‚úèÔ∏è</button>
                        <button class="icon-btn delete-btn" data-id="{{ task._id }}">üóëÔ∏è</button>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
            <div class="board-footer">
                <button class="footer-btn" onclick="openAddModalForCity('{{ city }}')">‚úèÔ∏è</button>
                <button class="footer-btn add-board-btn" onclick="openAddModalForCity('{{ city }}')">+</button>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="footer-text">
        HANDS UP FOR  <a href="#">JAYANT MULE</a>
    </div>

    <!-- Add Task Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Add New Task</div>
            <form action="/create" method="POST">
                <div class="form-group">
                    <label for="title">Task Title</label>
                    <input type="text" id="title" name="title" required placeholder="Enter task title...">
                </div>
                <div class="form-group">
                    <label for="city">City/Category</label>
                    <select id="city" name="description" onchange="toggleCustomCityInput()">
                        <option value="Pune">Pune</option>
                        <option value="Mumbai">Mumbai</option>
                        <option value="Other">Other City (Custom)</option>
                    </select>
                </div>
                <div class="form-group" id="customCityGroup" style="display: none;">
                    <label for="customCity">Enter City Name</label>
                    <input type="text" id="customCity" name="customCity" placeholder="Enter custom city name...">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Edit Task</div>
            <form id="editForm" method="POST">
                <div class="form-group">
                    <label for="editTitle">Task Title</label>
                    <input type="text" id="editTitle" name="title" required>
                </div>
                <div class="form-group">
                    <label for="editCity">City/Category</label>
                    <select id="editCity" name="description" onchange="toggleEditCustomCityInput()">
                        <option value="Pune">Pune</option>
                        <option value="Mumbai">Mumbai</option>
                        <option value="Other">Other City (Custom)</option>
                    </select>
                </div>
                <div class="form-group" id="editCustomCityGroup" style="display: none;">
                    <label for="editCustomCity">Enter City Name</label>
                    <input type="text" id="editCustomCity" name="customCity" placeholder="Enter custom city name...">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editCompleted" name="completed">
                        Mark as completed
                    </label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Task</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Toggle custom city input in Add Modal
        function toggleCustomCityInput() {
            var citySelect = document.getElementById('city');
            var customCityGroup = document.getElementById('customCityGroup');
            var customCityInput = document.getElementById('customCity');
            
            if (citySelect.value === 'Other') {
                customCityGroup.style.display = 'block';
                customCityInput.required = true;
            } else {
                customCityGroup.style.display = 'none';
                customCityInput.required = false;
                customCityInput.value = '';
            }
        }

        // Toggle custom city input in Edit Modal
        function toggleEditCustomCityInput() {
            var citySelect = document.getElementById('editCity');
            var customCityGroup = document.getElementById('editCustomCityGroup');
            var customCityInput = document.getElementById('editCustomCity');
            
            if (citySelect.value === 'Other') {
                customCityGroup.style.display = 'block';
                customCityInput.required = true;
            } else {
                customCityGroup.style.display = 'none';
                customCityInput.required = false;
                customCityInput.value = '';
            }
        }

        // Event listeners for edit and delete buttons
        document.addEventListener('DOMContentLoaded', function() {
            // Edit buttons
            document.querySelectorAll('.edit-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var taskId = this.getAttribute('data-id');
                    var title = this.getAttribute('data-title');
                    var description = this.getAttribute('data-description');
                    var completed = this.getAttribute('data-completed') === 'True';
                    openEditModal(taskId, title, description, completed);
                });
            });

            // Delete buttons
            document.querySelectorAll('.delete-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var taskId = this.getAttribute('data-id');
                    deleteTask(taskId);
                });
            });
        });

        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
            toggleCustomCityInput(); // Reset custom city input visibility
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
            document.getElementById('city').value = 'Pune';
            document.getElementById('customCity').value = '';
            toggleCustomCityInput();
        }

        function openAddModalForCity(city) {
            if (city === 'Pune' || city === 'Mumbai' ) {
                document.getElementById('city').value = city;
                toggleCustomCityInput();
            } else {
                document.getElementById('city').value = 'Other';
                document.getElementById('customCity').value = city;
                toggleCustomCityInput();
            }
            openAddModal();
        }

        function openEditModal(taskId, title, description, completed) {
            var modal = document.getElementById('editModal');
            var form = document.getElementById('editForm');
            
            form.action = '/update/' + taskId;
            document.getElementById('editTitle').value = title;
            
            // Handle city/description
            if (description === 'Pune' || description === 'Mumbai' ) {
                document.getElementById('editCity').value = description;
            } else {
                document.getElementById('editCity').value = 'Other';
                document.getElementById('editCustomCity').value = description;
            }
            
            toggleEditCustomCityInput();
            document.getElementById('editCompleted').checked = completed;
            
            modal.classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                window.location.href = '/delete/' + taskId;
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            var addModal = document.getElementById('addModal');
            var editModal = document.getElementById('editModal');
            if (event.target == addModal) {
                closeAddModal();
            }
            if (event.target == editModal) {
                closeEditModal();
            }
        }
    </script>
</body>
</html>
